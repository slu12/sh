// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/Error ../../../core/iteratorUtils ../../../core/lang ../../../core/Logger ../../../core/MemCache ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../support/PromiseQueue".split(" "),
function(x,E,M,q,l,u,N,y,O,G,P,B,v,C,Q,J,K,r,L,R,z,F,S,k,T,U){Object.defineProperty(E,"__esModule",{value:!0});var V=O.getLogger("esri.layers.graphics.data.QueryEngine");x=function(){return function(e,a,b,c,d){void 0===a&&(a=null);this.attributes=e;this.geometry=b;this.centroid=c;this.filterFlags=d;this.groupId=-1;this.localId=a}}();E.Feature=x;var A=new Set,W=new G.MemCacheStorage(2E6),X=0;x=function(){function e(a){var b=this;this.capabilities={query:R.queryCapabilities};this.geometryType=a.geometryType;
this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.featureStore=a.featureStore;this._changeHandle=this.featureStore.events.on("changed",function(){return b.clearCache()});this.timeInfo=a.timeInfo;this.cacheSpatialQueries&&(this._geometryQueryCache=new G.MemCache(X++ +"$$",W));this.fieldsIndex=new T(a.fields);a.scheduler&&a.task&&(this._frameQueue=
new U.PromiseQueue,this._frameTask=a.scheduler.registerTask(a.task,function(a){return b._update(a)},function(){return 0<b._frameQueue.length}))}e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null);this.clearCache();this._geometryQueryCache&&this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};Object.defineProperty(e.prototype,
"featureAdapter",{get:function(){return this.featureStore.featureAdapter},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"fullExtent",{get:function(){var a=this.featureStore.fullBounds;return a?{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:k.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=S.getTimeExtent(this.timeInfo,
this.featureStore):null},enumerable:!0,configurable:!0});e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};e.prototype.executeQuery=function(a,b){void 0===a&&(a={});return l(this,void 0,void 0,function(){var c,b,g;return q(this,function(d){switch(d.label){case 0:c=y.clone(a),d.label=1;case 1:return d.trys.push([1,14,,15]),[4,this._schedule()];case 2:return d.sent(),[4,k.normalizeQuery(c,this.definitionExpression,this.spatialReference)];
case 3:return c=d.sent(),[4,this._reschedule()];case 4:return d.sent(),[4,this._checkQuerySupport(c)];case 5:return c=d.sent(),[4,this._reschedule()];case 6:return d.sent(),[4,this._executeGeometryQuery(c)];case 7:return b=d.sent(),[4,this._reschedule()];case 8:return d.sent(),[4,b.executeObjectIdsQuery(c)];case 9:return b=d.sent(),[4,this._reschedule()];case 10:return d.sent(),[4,b.executeTimeQuery(c)];case 11:return b=d.sent(),[4,this._reschedule()];case 12:return d.sent(),[4,b.executeAttributesQuery(c)];
case 13:return b=d.sent(),[3,15];case 14:g=d.sent();if(g!==k.QUERY_ENGINE_EMPTY_RESULT)throw g;b=new z.default([],null,this);return[3,15];case 15:return[2,b.createQueryResponse(c)]}})})};e.prototype.executeQueryForCount=function(a,b){void 0===a&&(a={});return l(this,void 0,void 0,function(){var c,b,g;return q(this,function(d){switch(d.label){case 0:c=y.clone(a),c.returnGeometry=!1,c.returnCentroid=!1,c.outSR=null,d.label=1;case 1:return d.trys.push([1,14,,15]),[4,this._schedule()];case 2:return d.sent(),
[4,k.normalizeQuery(c,this.definitionExpression,this.spatialReference)];case 3:return c=d.sent(),[4,this._reschedule()];case 4:return d.sent(),[4,this._checkQuerySupport(c)];case 5:return c=d.sent(),[4,this._reschedule()];case 6:return d.sent(),[4,this._executeGeometryQuery(c)];case 7:return b=d.sent(),[4,this._reschedule()];case 8:return d.sent(),[4,b.executeObjectIdsQuery(c)];case 9:return b=d.sent(),[4,this._reschedule()];case 10:return d.sent(),[4,b.executeTimeQuery(c)];case 11:return b=d.sent(),
[4,this._reschedule()];case 12:return d.sent(),[4,b.executeAttributesQuery(c)];case 13:return b=d.sent(),[2,b.size];case 14:g=d.sent();if(g!==k.QUERY_ENGINE_EMPTY_RESULT)throw g;return[2,0];case 15:return[2]}})})};e.prototype.executeQueryForExtent=function(a,b){void 0===a&&(a={});return l(this,void 0,void 0,function(){var b,d,g,e,m,f,h,n;return q(this,function(c){switch(c.label){case 0:b=y.clone(a),g=b.outSR,c.label=1;case 1:return c.trys.push([1,14,,15]),[4,this._schedule()];case 2:return c.sent(),
[4,k.normalizeQuery(b,this.definitionExpression,this.spatialReference)];case 3:return b=c.sent(),[4,this._reschedule()];case 4:return c.sent(),[4,this._checkQuerySupport(b)];case 5:return b=c.sent(),b.returnGeometry=!0,b.returnCentroid=!1,b.outSR=null,[4,this._reschedule()];case 6:return c.sent(),[4,this._executeGeometryQuery(b)];case 7:return d=c.sent(),[4,this._reschedule()];case 8:return c.sent(),[4,d.executeObjectIdsQuery(b)];case 9:return d=c.sent(),[4,this._reschedule()];case 10:return c.sent(),
[4,d.executeTimeQuery(b)];case 11:return d=c.sent(),[4,this._reschedule()];case 12:return c.sent(),[4,d.executeAttributesQuery(b)];case 13:d=c.sent();e=d.size;if(!e)return[2,{count:e,extent:null}];v.set(p,v.NEGATIVE_INFINITY);this.featureStore.forEachBounds(d.items,function(a){return v.expand(p,a)},Y);m={xmin:p[0],ymin:p[1],xmax:p[3],ymax:p[4],spatialReference:k.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(p[2])&&isFinite(p[5])&&(m.zmin=p[2],m.zmax=p[5]);f=L.project(m,d.spatialReference,
g);f.spatialReference=k.cleanFromGeometryEngine(g||this.spatialReference);0===f.xmax-f.xmin&&(h=B.getMetersPerUnitForSR(f.spatialReference),f.xmin-=h,f.xmax+=h);0===f.ymax-f.ymin&&(h=B.getMetersPerUnitForSR(f.spatialReference),f.ymin-=h,f.ymax+=h);this.hasZ&&null!=f.zmin&&null!=f.zmax&&0===f.zmax-f.zmin&&(h=B.getMetersPerUnitForSR(f.spatialReference),f.zmin-=h,f.zmax+=h);return[2,{count:e,extent:f}];case 14:n=c.sent();if(n===k.QUERY_ENGINE_EMPTY_RESULT)return[2,{count:0,extent:null}];throw n;case 15:return[2]}})})};
e.prototype.executeQueryForIds=function(a,b){void 0===a&&(a={});return l(this,void 0,void 0,function(){return q(this,function(c){return[2,this.executeQueryForIdSet(a,b).then(function(a){return N.valuesOfSet(a)})]})})};e.prototype.executeQueryForIdSet=function(a,b){void 0===a&&(a={});return l(this,void 0,void 0,function(){var b,d,g,e,m,f,h,n;return q(this,function(c){switch(c.label){case 0:b=y.clone(a),b.returnGeometry=!1,b.returnCentroid=!1,b.outSR=null,c.label=1;case 1:return c.trys.push([1,13,,
14]),[4,this._schedule()];case 2:return c.sent(),[4,k.normalizeQuery(b,this.definitionExpression,this.spatialReference)];case 3:return b=c.sent(),[4,this._reschedule()];case 4:return c.sent(),[4,this._executeGeometryQuery(b)];case 5:return d=c.sent(),[4,this._reschedule()];case 6:return c.sent(),[4,d.executeObjectIdsQuery(b)];case 7:return d=c.sent(),[4,this._reschedule()];case 8:return c.sent(),[4,d.executeTimeQuery(b)];case 9:return d=c.sent(),[4,this._reschedule()];case 10:return c.sent(),[4,d.executeAttributesQuery(b)];
case 11:return d=c.sent(),[4,this._reschedule()];case 12:c.sent();g=d.items;e=new Set;m=0;for(f=g;m<f.length;m++)h=f[m],e.add(d.featureAdapter.getObjectId(h));return[2,e];case 13:n=c.sent();if(n===k.QUERY_ENGINE_EMPTY_RESULT)return[2,new Set];throw n;case 14:return[2]}})})};e.prototype.executeQueryForLatestObservations=function(a,b){var c=this;if(this.timeInfo)return this.executeQuery(a,b).then(function(a){return c._filterLatest(a,c.timeInfo)});V.error(new u("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))};
e.prototype._schedule=function(a){return l(this,void 0,void 0,function(){return q(this,function(b){return this._frameQueue?[2,this._frameQueue.push(a).then(function(a){return a})]:[2,a]})})};e.prototype._reschedule=function(a){return l(this,void 0,void 0,function(){return q(this,function(b){return this._frameQueue?[2,this._frameQueue.unshift(a).then(function(a){return a})]:[2,a]})})};e.prototype._update=function(a){for(this._budget=a;!a.done&&this._frameQueue&&this._frameQueue.process();)a.madeProgress();
this._budget=null};e.prototype._filterLatest=function(a,b){var c=b.trackIdField,d=b.startTimeField;b=b.endTimeField||d;for(var d=new Map,g=[],e=0,m=a.features;e<m.length;e++){var f=m[e],h=f.attributes[c],n=f.attributes[b];(!d.has(h)||d.get(h).attributes[b]<n)&&d.set(h,f)}d.forEach(function(a){return g.push(a)});return M({},a,{features:g})};e.prototype._getAll=function(){if(!this._allItems){var a=[];this.featureStore.forEach(function(b){return a.push(b)});this._allItems=new z.default(a,null,this)}return this._allItems};
e.prototype._executeGeometryQuery=function(a){return l(this,void 0,void 0,function(){var b,c,d,e,w,m,f,h,n,k,p,t,r,I,u,v,x,y,D,A,H,E,B,C,G=this;return q(this,function(g){switch(g.label){case 0:b=a.geometry;c=a.outSR;d=a.spatialRel;e=K.isValid(c)&&!K.equals(this.spatialReference,c);if(w=this.cacheSpatialQueries?e?JSON.stringify({geometry:b,spatialRelationship:d,outSpatialReference:c}):JSON.stringify({geometry:b,spatialRelationship:d}):null)if(m=this._geometryQueryCache.get(w),void 0!==m)return[2,m];
f=function(b){return l(G,void 0,void 0,function(){var d;return q(this,function(f){switch(f.label){case 0:return e&&(a.returnGeometry||a.returnCentroid)?[4,b.project(c)]:[3,2];case 1:return d=f.sent(),w&&this._geometryQueryCache.put(w,d,d.size||1),[2,d];case 2:return w&&this._geometryQueryCache.put(w,b,b.size||1),[2,b]}})})};if(!b)return[2,f(this._getAll())];h=this.featureAdapter;if("esriSpatialRelDisjoint"!==d)return[3,5];n=this._searchFeatures(this._getQueryBBoxes(b));if(!n.length)return[2,f(this._getAll())];
t=new Set;r=0;for(I=n;r<I.length;r++)u=I[r],t.add(h.getObjectId(u));return[4,this._reschedule(t)];case 1:return t=g.sent(),v=0,k=Array(t.size),this.featureStore.forEach(function(a){return k[v++]=a}),p=t,[4,this._reschedule()];case 2:return g.sent(),[4,F.getSpatialQueryOperator(d,b,this)];case 3:return x=g.sent(),y=function(a){return!p.has(h.getObjectId(a))||x(h.getGeometry(a))},A=z.default.bind,[4,this._runSpatialFilter(k,y)];case 4:return D=new (A.apply(z.default,[void 0,g.sent(),b,this])),[2,f(D)];
case 5:return H=this._searchFeatures(this._getQueryBBoxes(b)),H.length?(E=this._canExecuteSoloPass(b,a))?[2,f(new z.default(H,b,this))]:[4,F.getSpatialQueryOperator(d,b,this)]:(D=new z.default([],b,this),w&&this._geometryQueryCache.put(w,D,D.size||1),[2,D]);case 6:return B=g.sent(),[4,this._runSpatialFilter(H,function(a){return B(h.getGeometry(a))})];case 7:return C=g.sent(),[2,f(new z.default(C,b,this))]}})})};e.prototype._runSpatialFilter=function(a,b){return l(this,void 0,void 0,function(){var c,
d,e,k=this;return q(this,function(g){if(!b)return[2,a];if(!this._budget)return[2,a.filter(function(a){return b(a)})];c=0;d=[];e=function(){return l(k,void 0,void 0,function(){var f;return q(this,function(g){switch(g.label){case 0:if(!(c<a.length))return[3,3];f=a[c];b(f)&&d.push(f);return this._budget.done?[4,this._reschedule()]:[3,2];case 1:return g.sent(),[2,e()];case 2:return++c,[3,0];case 3:return[2]}})})};return[2,this._reschedule().then(function(){return e()}).then(function(){return d})]})})};
e.prototype._canExecuteSoloPass=function(a,b){var c=this.geometryType;b=b.spatialRel;return F.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===c&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b||"esriSpatialRelWithin"===b))};e.prototype._getQueryBBoxes=function(a){if(F.canQueryWithRBush(a)){if(J.isExtent(a))return[C.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];if(J.isPolygon(a))return a.rings.map(function(a){return C.fromValues(Math.min(a[0][0],a[2][0]),
Math.min(a[0][1],a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1]))})}return[Q.getBoundsXY(C.create(),a)]};e.prototype._searchFeatures=function(a){for(var b=0;b<a.length;b++)this.featureStore.forEachInBounds(a[b],function(a){A.add(a)});var c=Array(A.size),d=0;A.forEach(function(a){return c[d++]=a});A.clear();return c};e.prototype._checkQuerySupport=function(a){return l(this,void 0,void 0,function(){return q(this,function(b){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||
a.pixelSize||a.relationParam||a.text)throw new u("feature-store:unsupported-query","Unsupported query options",{query:a});return[2,P.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),F.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),L.checkProjectionSupport(this.spatialReference,a.outSR)]).then(function(){return a})]})})};e.prototype._checkAttributesQuerySupport=function(a){var b=a.outFields,c=a.orderByFields,d=a.returnDistinctValues;c&&0<c.length&&
(c=c.map(function(a){return-1<a.indexOf(" ASC")?a.split(" ASC")[0]:-1<a.indexOf(" DESC")?a.split(" DESC")[0]:a}),r.validateFields(this.fieldsIndex,c,"orderByFields contains missing fields"));if(b&&0<b.length)r.validateFields(this.fieldsIndex,b,"outFields contains missing fields");else if(d)throw new u("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});r.validateWhere(this.fieldsIndex,a.where)};e.prototype._checkStatisticsQuerySupport=function(a){return l(this,
void 0,void 0,function(){var b,c,d,e,k,m,f,h,n,l,p,t;return q(this,function(g){b=a.outStatistics;c=a.groupByFieldsForStatistics;d=a.having;e=c&&c.length;k=b&&b.length;if(d){if(!e||!k)throw new u("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});r.validateHaving(this.fieldsIndex,d,b)}if(k){if(m=b.some(function(a){return"exceedslimit"===a.statisticType}))return[2];f=b.map(function(a){return a.onStatisticField});r.validateFields(this.fieldsIndex,
f,"onStatisticFields contains missing fields");e&&r.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");h=0;for(n=b;h<n.length;h++)if(l=n[h],p=l.onStatisticField,t=l.statisticType,(!e||"count"!==t)&&p&&r.hasInvalidFieldType(p,this.fieldsIndex))throw new u("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:l,query:a});}return[2]})})};return e}();E.default=x;var Y=v.create(),p=v.create()});