// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper @dojo/framework/shim/array ../../core/Error ../../core/iteratorUtils ../../core/maybe ../../core/object ../../core/promiseUtils ./domains ../../support/arcadeOnDemand".split(" "),function(P,c,Y,k,l,r,Q,t,F,x,G,u,R){function H(a,b,d){if(a)for(var c=0;c<a.length;c++){var f=a[c],g=x.getDeepValue(f,b);(g=g&&"function"!==typeof g&&n(d,g))&&x.setDeepValue(f,g.name,b)}}function q(a,
b){if(!a||!b)return[];y.clear();v(y,a,b);return t.valuesOfSet(y).sort()}function v(a,b,d){if(d)if(b&&b.length)if(r.includes(d,"*"))for(d=0;d<b.length;d++)a.add(b[d].name);else for(var c=0;c<d.length;c++)f=d[c],p(a,b,f);else if(r.includes(d,"*"))a.clear(),a.add("*");else for(b=0;b<d.length;b++){var f=d[b];a.add(f)}}function p(a,b,d){b&&b.length?(b=n(b,d))&&a.add(b.name):"string"===typeof d&&a.add(d)}function n(a,b){if("string"!==typeof b)return null;if(null!=a){b=b.toLowerCase();for(var d=0;d<a.length;d++){var c=
a[d];if(c&&c.name.toLowerCase()===b)return c}}return null}function I(a,b,d){return l(this,void 0,void 0,function(){var c,f,g,m,h;return k(this,function(e){switch(e.label){case 0:return d?[4,R.loadArcade()]:[2];case 1:c=e.sent().arcadeUtils;f=c.extractFieldNames(d);g=0;for(m=f;g<m.length;g++)h=m[g],p(a,b,h);return[2]}})})}function J(a,b){return l(this,void 0,void 0,function(){var d,c;return k(this,function(e){if(!b)return[2];d=b.fields;return(c=x.getDeepValue("elevationInfo.featureExpressionInfo",
b))?[2,c.collectRequiredFields(a,d)]:[2]})})}function K(a,b){return l(this,void 0,void 0,function(){var d,c;return k(this,function(e){switch(e.label){case 0:return d=b.labelingInfo,c=b.fields,d&&d.length?[4,G.all(d.map(function(b){return S(a,c,b)}))]:[2];case 1:return e.sent(),[2]}})})}function S(a,b,d){return l(this,void 0,void 0,function(){var c,f,g,m,h;return k(this,function(e){switch(e.label){case 0:if(!d)return[2];c=d.getLabelExpression();f=d.where;return"arcade"!==c.type?[3,2]:[4,I(a,b,c.expression)];
case 1:return e.sent(),[3,3];case 2:(g=c.expression.match(/{[^}]*}/g))&&g.forEach(function(d){p(a,b,d.slice(1,-1))}),e.label=3;case 3:return m=/['"]+/g,f&&(h=f.split(" "),3===h.length&&p(a,b,h[0].replace(m,"")),7===h.length&&(p(a,b,h[0].replace(m,"")),p(a,b,h[4].replace(m,"")))),[2]}})})}function z(a){return"number"===typeof a&&!isNaN(a)&&isFinite(a)}function T(a){return null===a||z(a)}function U(a){return null===a||w(a)}function L(a){return null!=a&&"string"===typeof a}function V(a){return null===
a||L(a)}function W(){return!0}function A(a,b){var d;switch(a.type){case "date":case "integer":case "long":case "small-integer":case "esriFieldTypeDate":case "esriFieldTypeInteger":case "esriFieldTypeLong":case "esriFieldTypeSmallInteger":d=a.nullable?U:w;break;case "double":case "single":case "esriFieldTypeSingle":case "esriFieldTypeDouble":d=a.nullable?T:z;break;case "string":case "esriFieldTypeString":d=a.nullable?V:L;break;default:d=W}return 1===arguments.length?d:d(b)}function B(a){return null!=
a&&X.has(a.type)}function M(a,b){return a.nullable&&null===b?null:B(a)&&!N(a.type,Number(b))?C.OUT_OF_RANGE:A(a,b)?a.domain?u.validateDomainValue(a.domain,b):null:D.INVALID_TYPE}function N(a,b){return(a="string"===typeof a?E(a):a)?a.isInteger?w(b)&&b>=a.min&&b<=a.max:b>=a.min&&b<=a.max:!1}function E(a){switch(a){case "esriFieldTypeSmallInteger":case "small-integer":return c.smallIntegerRange;case "esriFieldTypeInteger":case "integer":return c.integerRange;case "esriFieldTypeSingle":case "single":return c.singleRange;
case "esriFieldTypeDouble":case "double":return c.doubleRange}}function O(a,b,d){if(!b||!b.attributes||!a){if(F.isSome(d))for(var c=0;c<a.length;c++)b=a[c],d.add(b);return!0}for(var c=b.attributes,f=!1,g=0;g<a.length;g++)if(b=a[g],!(b in c))if(f=!0,F.isSome(d))d.add(b);else break;return f}Object.defineProperty(c,"__esModule",{value:!0});c.rendererFields="field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" ");
c.visualVariableFields=["field","normalizationField"];c.fixRendererFields=function(a,b){if(null!=a&&null!=b){var d=0;for(a=Array.isArray(a)?a:[a];d<a.length;d++){var e=a[d];H(c.rendererFields,e,b);if("visualVariables"in e&&e.visualVariables)for(var f=0,e=e.visualVariables;f<e.length;f++)H(c.visualVariableFields,e[f],b)}}};c.fixTimeInfoFields=function(a,b){if(null!=a&&null!=b)if("startField"in a){var d=n(b,a.startField);b=n(b,a.endField);a.startField=d&&d.name||null;a.endField=b&&b.name||null}else d=
n(b,a.startTimeField),b=n(b,a.endTimeField),a.startTimeField=d&&d.name||null,a.endTimeField=b&&b.name||null};var y=new Set;c.fixFields=q;c.collectFields=v;c.collectField=p;c.unpackFieldNames=function(a,b){return b&&a?r.includes(b,"*")?a.map(function(a){return a.name}):b:[]};c.packFields=function(a,b,c){void 0===c&&(c=1);if(!b||!a)return[];if(r.includes(b,"*"))return["*"];b=q(a,b);return b.length/a.length>=c?["*"]:b};c.getField=n;c.hasField=function(a,b){if(!a||!b||"string"!==typeof b)return!1;b=b.toLowerCase();
for(var c=0;c<a.length;c++){var e=a[c];if(e&&e.name.toLowerCase()===b)return!0}return!1};c.collectArcadeFieldNames=I;c.getElevationFields=function(a){return l(this,void 0,void 0,function(){var b;return k(this,function(c){switch(c.label){case 0:if(!a)return[2,[]];b=new Set;return[4,J(b,a)];case 1:return c.sent(),[2,t.valuesOfSet(b).sort()]}})})};c.collectElevationFields=J;c.collectFilterFields=function(a,b,c){return l(this,void 0,void 0,function(){var d,f;return k(this,function(e){switch(e.label){case 0:if(!b||
!c||!(c.where&&"1\x3d1"!==c.where||c.timeExtent))return[2];b.timeInfo&&c.timeExtent&&v(a,b.fields,[b.timeInfo.startField,b.timeInfo.endField]);return c.where?[4,G.create(function(a){P(["../../core/sql/WhereClause"],a)})]:[3,2];case 1:d=e.sent();f=d.WhereClause.create(c.where,b.fieldsIndex);if(!f.isStandardized)throw new Q("fieldUtils:collectFilterFields","Where clause is not standardized");v(a,b.fields,f.fieldNames);e.label=2;case 2:return[2]}})})};c.getTimeFields=function(a){return l(this,void 0,
void 0,function(){var b;return k(this,function(c){return a?(b="timeInfo"in a&&a.timeInfo)?[2,q(a.fields,[a.trackIdField,b.startField,b.endField])]:[2,[]]:[2,[]]})})};c.getFeatureEditFields=function(a){if(!a)return[];var b="editFieldsInfo"in a&&a.editFieldsInfo;return b?q(a.fields,[b&&b.creatorField,b&&b.creationDateField,b&&b.editorField,b&&b.editDateField]):[]};c.getFeatureGeometryFields=function(a){if(!a)return[];var b="geometryProperties"in a&&a.geometryProperties;return b?q(a.fields,[b&&b.shapeAreaFieldName,
b&&b.shapeLengthFieldName]):[]};c.getLabelingFields=function(a){return l(this,void 0,void 0,function(){var b;return k(this,function(c){switch(c.label){case 0:if(!a)return[2,[]];b=new Set;return[4,K(b,a)];case 1:return c.sent(),[2,t.valuesOfSet(b).sort()]}})})};c.collectLabelingFields=K;c.getFieldDefaultValue=function(a){var b=a.defaultValue;if(void 0!==b&&A(a,b))return b;if(a.nullable)return null};var w=function(){return"isInteger"in Number?Number.isInteger:function(a){return"number"===typeof a&&
isFinite(a)&&Math.floor(a)===a}}();c.isValueMatchingFieldType=A;c.numericTypes=["integer","small-integer","single","double"];var X=t.createSetFromValues(c.numericTypes.concat(["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]));c.isNumericField=B;c.isStringField=function(a){return null!=a&&("string"===a.type||"esriFieldTypeString"===a.type)};c.isDateField=function(a){return null!=a&&("date"===a.type||"esriFieldTypeDate"===a.type)};c.isValidFieldValue=
function(a,b){return null===M(a,b)};var C;(C=c.NumericRangeValidationError||(c.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range";var D;(D=c.TypeValidationError||(c.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";c.sanitizeNullFieldValue=function(a){return null==a||"number"===typeof a&&isNaN(a)?null:a};c.validateFieldValue=M;c.isNumberInRange=N;c.getFieldRange=function(a){var b=u.getDomainRange(a.domain);if(b)return b;if(B(a))return E(a.type)};
c.getNumericTypeForValue=function(a){if(!z(a))return null;if(w(a)){if(a>=c.smallIntegerRange.min&&a<=c.smallIntegerRange.max)return"esriFieldTypeSmallInteger";if(a>=c.integerRange.min&&a<=c.integerRange.max)return"esriFieldTypeInteger"}return a>=c.singleRange.min&&a<=c.singleRange.max?"esriFieldTypeSingle":"esriFieldTypeDouble"};c.smallIntegerRange={min:-32768,max:32767,isInteger:!0};c.integerRange={min:-2147483648,max:2147483647,isInteger:!0};c.singleRange={min:-3.4E38,max:1.2E38,isInteger:!1};c.doubleRange=
{min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};c.validationErrorToString=function(a,b,c){switch(a){case u.DomainValidationError.INVALID_CODED_VALUE:return"Value "+c+" is not in the coded domain - field: "+b.name+", domain: "+JSON.stringify(b.domain);case u.DomainValidationError.VALUE_OUT_OF_RANGE:return"Value "+c+" is out of the range of valid values - field: "+b.name+", domain: "+JSON.stringify(b.domain);case D.INVALID_TYPE:return"Value "+c+" is not a valid value for the field type - field: "+
b.name+", type: "+b.type+", nullable: "+b.nullable;case C.OUT_OF_RANGE:return a=E(b.type),"Value "+c+" is out of range for the number type - field: "+b.name+", type: "+b.type+", value range is "+a.min+" to "+a.max}};c.featureHasFields=function(a,b){return!O(a,b,null)};c.populateMissingFields=O});