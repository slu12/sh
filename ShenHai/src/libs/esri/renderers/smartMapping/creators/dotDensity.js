// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/assignHelper ../.. ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./support/dotDensityUtils ./support/utils ../heuristics/outline ../statistics/spatialStatistics ../statistics/summaryStatisticsForAttributes ../statistics/support/attributeDensity ../support/utils ../symbology/dotDensity ../../support/AuthoringInfo".split(" "),
function(R,C,m,n,G,H,v,D,z,E,y,A,I,J,K,L,B,F,M){function N(b){return n(this,void 0,void 0,function(){var a,c,d,f;return m(this,function(e){switch(e.label){case 0:if(!(b&&b.layer&&b.view&&b.attributes&&b.attributes.length))throw new v("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(8<b.attributes.length)throw new v("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");a=G({},b);c=[2,1];d=B.createLayerAdapter(a.layer,
c);a.layer=d;a.dotBlendingEnabled=null==a.dotBlendingEnabled?!0:a.dotBlendingEnabled;a.dotValueOptimizationEnabled=null==a.dotValueOptimizationEnabled?!0:a.dotValueOptimizationEnabled;if(!d)throw new v("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+B.getLayerTypeLabels(c).join(", "));return[4,z.all([a.view.when(),d.load()])];case 1:e.sent();f=d.geometryType;if("polygon"!==f)throw new v("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");
return[2,a]}})})}function O(b){return n(this,void 0,void 0,function(){var a,c,d,f,e;return m(this,function(h){switch(h.label){case 0:return a=b.dotDensityScheme,d=c=null,[4,A.getBasemapInfo(b.basemap,b.view)];case 1:f=h.sent();c=D.isSome(f.basemapId)?f.basemapId:null;d=D.isSome(f.basemapTheme)?f.basemapTheme:null;if(a)return[2,{scheme:F.cloneScheme(a),basemapId:c,basemapTheme:d}];if(e=F.getSchemes({basemap:c,numColors:b.attributes.length,basemapTheme:d}))a=e.primaryScheme,c=e.basemapId,d=e.basemapTheme;
return[2,{scheme:a,basemapId:c,basemapTheme:d}]}})})}function P(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,h,q,l,k,g,r,p;return m(this,function(t){switch(t.label){case 0:return a=b.view,c=b.layer,d=b.attributes,[4,c.getSampleFeatures({view:a,sampleSize:500,returnGeometry:!0})];case 1:return f=t.sent(),[4,z.all([J({features:f,geometryType:c.geometryType}),K({layer:c,attributes:d,includeZeros:!1,includeNegatives:!1,view:a})])];case 2:e=t.sent();h=e[0];q=e[1];l="avgSize"in h&&h.avgSize;
k=q.avg;if(!l)throw new v("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!k)throw new v("dot-density-renderer:insufficient-info","Average attribute value is invalid");g=E.getResolutionForScale(a.scale,a.spatialReference);r=l*l/(g*g)*.1;p=y.roundValue(k/r);return[2,{dotValue:p||1,referenceScale:a.scale,minSliderValue:1,maxSliderValue:y.roundValue(k)}]}})})}function Q(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,h,q,l,k,g,r,p,t,w,x;return m(this,function(u){switch(u.label){case 0:a=
b.view,c=b.layer,d=b.attributes,f=[],e=0,h=d,u.label=1;case 1:if(!(e<h.length))return[3,4];q=h[e];return[4,B.getFieldsList({field:q.field,valueExpression:q.valueExpression})];case 2:l=u.sent(),f.push.apply(f,l),u.label=3;case 3:return e++,[3,1];case 4:return[4,c.getSampleFeatures({view:a,sampleSize:500,requiredFields:f,returnGeometry:!0})];case 5:return k=u.sent(),[4,L({features:k,attributes:d,includeZeros:!1,includeNegatives:!1,view:a})];case 6:g=u.sent();if(!g.avgDensity||!g.minDensity||!g.maxDensity)throw new v("dot-density-renderer:insufficient-info",
"Invalid density values");r=E.getResolutionForScale(a.scale,a.spatialReference);p=r*r;t=y.roundValue(g.minDensity*p);w=y.roundValue(g.maxDensity*p);x=y.roundValue(g.avgDensity*p*10)||1;x>w&&(x=w);return[2,{dotValue:x,referenceScale:a.scale,minSliderValue:t,maxSliderValue:w}]}})})}Object.defineProperty(C,"__esModule",{value:!0});C.createRenderer=function(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,h,q,l,k,g,r,p,t,w,x,u,n;return m(this,function(m){switch(m.label){case 0:return[4,N(b)];case 1:return a=
m.sent(),c=a.layer,d=c.geometryType,[4,O(a)];case 2:e=(f=m.sent())&&f.scheme;if(!e)throw new v("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");h={layer:c,view:a.view,attributes:a.attributes};q={layer:a.layer,view:a.view};return[4,z.all([a.trueDensity?Q(h):P(h),a.outlineOptimizationEnabled?I(q):null])];case 3:return l=m.sent(),k=l[0],g=l[1],r=k.dotValue,p=k.referenceScale,t=k.minSliderValue,w=k.maxSliderValue,x=A.createColors(e.colors,a.attributes.length),u=a.attributes.map(function(a,
b){return{field:a.field,valueExpression:a.valueExpression,label:a.label,valueExpressionTitle:a.valueExpressionTitle,color:x[b]}}),n=new H.DotDensityRenderer({attributes:u,dotBlendingEnabled:a.dotBlendingEnabled,outline:g?A.getSymbolOutlineFromScheme(e,d,g.opacity):null,dotValue:r,referenceScale:a.dotValueOptimizationEnabled?p:null,legendOptions:a.legendOptions}),g&&g.visualVariables&&g.visualVariables.length&&(n.visualVariables=g.visualVariables.map(function(a){return a.clone()})),n.authoringInfo=
new M({type:"dot-density",minSliderValue:t,maxSliderValue:w}),[2,{renderer:n,dotDensityScheme:e,basemapId:f.basemapId,basemapTheme:f.basemapTheme}]}})})}});