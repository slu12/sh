// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/screenUtils ../../../intl/substitute ./support/utils ../heuristics/ageUnit ../heuristics/outline ../heuristics/sizeRange ../statistics/support/ageUtils ../support/utils ../symbology/size ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/utils ../../visualVariables/SizeVariable".split(" "),
function(la,E,A,u,l,I,L,e,M,J,N,Y,m,Z,O,aa,G,n,B,P,ba,ca,Q){function da(b){return l(this,void 0,void 0,function(){var a,f,c,d,g,h;return u(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new e("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new e("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=A({},b);f=[0,2,1,3];c=n.createLayerAdapter(a.layer,f);a.layer=c;if(!c)throw new e("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(f).join(", "));"height"===a.axis&&(a.sizeOptimizationEnabled=!1);return[4,c.load()];case 1:k.sent();d=c.geometryType;if("mesh"===d)throw new e("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a.worldScale){if("polyline"===d||"polygon"===d)throw new e("size-visual-variable:not-supported",
"'worldScale' sizing is not supported for polyline and polygon layers");if(!a.view||"3d"!==a.view.type)throw new e("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true");}return[4,n.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:g=k.sent();if(h=m.verifyBasicFieldValidity(c,g,"size-visual-variable:invalid-parameters"))throw h;return[2,a]}})})}function ea(b){return l(this,
void 0,void 0,function(){var a,f,c,d,g,h,k;return u(this,function(q){switch(q.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new e("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new e("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=A({},b);a.symbolType=a.symbolType||"2d";
a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;f=[0,2,1,3];c=n.createLayerAdapter(a.layer,f);a.layer=c;if(!c)throw new e("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(f).join(", "));return[4,c.load()];case 1:q.sent();d=c.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new e("size-continuous-renderer:invalid-parameters",
"Size visualization is not applicable to layers with 'mesh' geometry type");if(g&&("polyline"===d||"polygon"===d))throw new e("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new e("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,n.getFieldsList({field:a.field,
normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:h=q.sent();if(k=m.verifyBasicFieldValidity(c,h,"size-continuous-renderer:invalid-parameters"))throw k;return[2,a]}})})}function fa(b){return l(this,void 0,void 0,function(){var a,f,c,d,g,h,k,q;return u(this,function(p){switch(p.label){case 0:if(!b||!b.layer||!b.field&&!b.valueExpression)throw new e("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&
!b.view)throw new e("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=A({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=n.getNormalizationType(a);f=[0,2,1,3];c=n.createLayerAdapter(a.layer,f);a.layer=c;if(!c)throw new e("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+
n.getLayerTypeLabels(f).join(", "));d=null!=a.minValue&&null!=a.maxValue;if(!d&&(null!=a.minValue||null!=a.maxValue))throw new e("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,c.load()];case 1:p.sent();g=c.geometryType;h=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===g?a.outlineOptimizationEnabled:!1;if("mesh"===g)throw new e("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");
if(h&&("polyline"===g||"polygon"===g))throw new e("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new e("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,n.getFieldsList({field:a.field,normalizationField:a.normalizationField})];
case 2:k=p.sent();if(q=m.verifyBasicFieldValidity(c,k,"size-class-breaks-renderer:invalid-parameters"))throw q;return[2,a]}})})}function ga(b){b=A({},b);delete b.basemap;delete b.sizeScheme;delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function R(b){b=A({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;delete b.defaultSymbolEnabled;
return b}function ha(b){return l(this,void 0,void 0,function(){var a,f,c,d,g,h;return u(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new e("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");a=A({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;f=[0,2,1,3];c=n.createLayerAdapter(a.layer,f);a.layer=c;if(!c)throw new e("size-age-renderer:invalid-parameters",
"'layer' must be one of these types: "+n.getLayerTypeLabels(f).join(", "));return[4,c.load()];case 1:k.sent();d=c.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new e("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(g&&("polyline"===d||"polygon"===d))throw new e("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");
if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new e("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(h=G.verifyDates(c,a.startTime,a.endTime,"size-age-renderer:invalid-parameters"))throw h;if(a.unit&&-1===G.supportedAgeUnits.indexOf(a.unit))throw new e("size-age-renderer:invalid-unit","Supported units are: "+G.supportedAgeUnits.join(", "));return[2,
a]}})})}function S(b){return l(this,void 0,void 0,function(){var a,f,c,d,g;return u(this,function(h){switch(h.label){case 0:return a=b.sizeScheme,c=f=null,[4,m.getBasemapInfo(b.basemap,b.view)];case 1:d=h.sent();f=M.isSome(d.basemapId)?d.basemapId:null;c=M.isSome(d.basemapTheme)?d.basemapTheme:null;if(a)return[2,{scheme:B.cloneScheme(a),basemapId:f,basemapTheme:c}];if(g=B.getSchemes({basemap:f,basemapTheme:c,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))a=g.primaryScheme,f=g.basemapId,
c=g.basemapTheme;return[2,{scheme:a,basemapId:f,basemapTheme:c}]}})})}function T(b,a){var f;switch(a){case "point":case "multipoint":f=[b.minSize,b.maxSize];break;case "polyline":f=[b.minWidth,b.maxWidth];break;case "polygon":f=[b.marker.minSize,b.marker.maxSize]}return f}function ia(b,a,f,c){return l(this,void 0,void 0,function(){var d,g,h,k,q,p,H,F,C,z,v,r,t,n,w,l,x,y,U,V;return u(this,function(u){switch(u.label){case 0:return d=c.layer,g=c.field,h="function"===typeof g,q=(k=g&&!h?d.getField(g):
null)&&"date"===k.type,p=d.geometryType,[4,S({basemap:c.basemap,geometryType:p,sizeScheme:c.sizeScheme,worldScale:c.worldScale,view:c.view})];case 1:H=u.sent();F=H.scheme;if(!F)throw new e("size-visual-variable:insufficient-info","Unable to find size scheme");z=(C=a&&[a.minSize,a.maxSize])||T(F,p);r=(v=m.getDefaultDataRange(b,q,!1))||[b.min,b.max];t=[];w=(n="height"===c.axis)?c.axis:void 0;l=z[0];x=z[1];n&&"number"===typeof l&&"number"===typeof x&&(y=m.getSizeRangeForAxis({minSize:l,maxSize:x},w),
t.push(new Q({axis:"width-and-depth",minSize:y.minSize})),x=y.maxSize);t.unshift(new Q({field:g,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,valueUnit:"unknown",normalizationField:f,axis:w,minSize:l,maxSize:x,minDataValue:r[0],maxDataValue:r[1],legendOptions:c.legendOptions}));U=new ba({type:"size",minSliderValue:null!=c.minValue?c.minValue:b.min,maxSliderValue:null!=c.maxValue?c.maxValue:b.max});V=new P({visualVariables:[U]});return[2,{basemapId:H.basemapId,basemapTheme:H.basemapTheme,
visualVariables:t,statistics:b,defaultValuesUsed:!!v,sizeScheme:B.cloneScheme(F),authoringInfo:V}]}})})}function W(b,a,f,c,d){var g=d.field,h=d.layer.geometryType,k=d.defaultSymbolEnabled,q=B.cloneScheme(b.sizeScheme),p="polygon"===h,e=p?q.marker:q,q=p?q.background:null,p=p?"point":h,l=a&&a.opacity,n=b.visualVariables.map(function(a){return a.clone()});a&&a.visualVariables&&a.visualVariables.length&&n.push.apply(n,a.visualVariables.map(function(a){return a.clone()}));return{renderer:new L.ClassBreaksRenderer({backgroundFillSymbol:q&&
m.createSymbol(h,{type:d.symbolType,color:q.color,outline:m.getSymbolOutlineFromScheme(q,h,l)}),classBreakInfos:[{minValue:-X,maxValue:X,symbol:m.createSymbol(p,{type:d.symbolType,color:e.color,size:m.getSymbolSizeFromScheme(e,p),outline:m.getSymbolOutlineFromScheme(e,p,l)})}],defaultLabel:k?I.other:null,defaultSymbol:k?m.createSymbol(p,{type:d.symbolType,color:e.noDataColor,size:m.getSymbolSizeFromScheme(e,p,!0),outline:m.getSymbolOutlineFromScheme(e,p,l)}):null,field:g,normalizationField:c,normalizationType:f,
valueExpression:d.valueExpression,valueExpressionTitle:d.valueExpressionTitle,visualVariables:n,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),visualVariables:b.visualVariables.map(function(a){return a.clone()}),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:B.cloneScheme(b.sizeScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}}function ja(b,a){var f=N.toPt(b.minSize);b=(N.toPt(b.maxSize)-f)/(4<=a?a-1:a);for(var c=[],d=0;d<a;d++)c.push(f+b*d);return c}function ka(b,
a){return l(this,void 0,void 0,function(){var f,c,d,g,h,k,e,p,l,n,C,z,v,r,t,D,w,A,x,y;return u(this,function(q){switch(q.label){case 0:return f=b.layer,c=b.defaultSymbolEnabled,d=f.geometryType,g="polygon"===d,h=-1<b.symbolType.indexOf("3d-volumetric"),[4,S({basemap:b.basemap,geometryType:d,sizeScheme:b.sizeScheme,worldScale:h,view:b.view})];case 1:return k=q.sent(),e=k.scheme,p=a.result,l=a.outlineResult,n=p.classBreakInfos,C=b.classificationMethod,z=b.normalizationType,v=g?e.marker:e,r=g?e.background:
null,t=g?"point":d,D=T(v,t),w=h&&m.getSizeRangeForAxis({minSize:D[0],maxSize:D[1]},"height"),A=ja({minSize:D[0],maxSize:h?w.maxSize:D[1]},n.length),x=l&&l.opacity,y=new L.ClassBreaksRenderer({backgroundFillSymbol:r&&m.createSymbol(d,{type:b.symbolType,color:r.color,outline:m.getSymbolOutlineFromScheme(r,d,x)}),classBreakInfos:n.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:m.createSymbol(t,{type:b.symbolType,color:v.color,size:A[c],widthAndDepth:w&&w.minSize,outline:m.getSymbolOutlineFromScheme(v,
t,x)}),label:a.label}}),defaultLabel:c?I.other:null,defaultSymbol:c?m.createSymbol(t,{type:b.symbolType,color:v.noDataColor,size:m.getSymbolSizeFromScheme(v,t,!0),widthAndDepth:w&&w.minSize,outline:m.getSymbolOutlineFromScheme(v,t,x)}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:z,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===z?p.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new P({type:"class-breaks-size",
classificationMethod:C,standardDeviationInterval:b.standardDeviationInterval})}),"standard-deviation"!==C&&ca.setLabelsForClassBreaks({classBreakInfos:y.classBreakInfos,classificationMethod:C,normalizationType:z,round:!0}),l&&l.visualVariables&&l.visualVariables.length&&(y.visualVariables=l.visualVariables.map(function(a){return a.clone()})),[2,{renderer:y,sizeScheme:B.cloneScheme(e),classBreaksResult:p,defaultValuesUsed:a.defaultValuesUsed,basemapId:k.basemapId,basemapTheme:k.basemapTheme}]}})})}
function K(b){return l(this,void 0,void 0,function(){var a,f,c,d,g,e,k,q;return u(this,function(h){switch(h.label){case 0:return[4,da(b)];case 1:return a=h.sent(),f=a.view,c=a.layer,g=(d=a.normalizationField)?"field":void 0,[4,J.all([a.statistics?a.statistics:m.getSummaryStatistics({layer:c,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:g,normalizationField:d,minValue:a.minValue,maxValue:a.maxValue,view:f}),a.sizeOptimizationEnabled?
aa({view:f,layer:c}):null])];case 2:return e=h.sent(),k=e[0],q=e[1],[2,ia(k,q,d,a)]}})})}Object.defineProperty(E,"__esModule",{value:!0});var X=Math.pow(2,53)-1;E.createVisualVariables=K;E.createContinuousRenderer=function(b){return l(this,void 0,void 0,function(){var a,f,c,d,g,e,k;return u(this,function(h){switch(h.label){case 0:return[4,ea(b)];case 1:return a=h.sent(),f={layer:a.layer,view:a.view},[4,J.all([K(R(a)),a.outlineOptimizationEnabled?O(f):null])];case 2:return c=h.sent(),d=c[0],g=c[1],
k=(e=a.normalizationField)?"field":void 0,[2,W(d,g,k,e,a)]}})})};E.createClassBreaksRenderer=function(b){return l(this,void 0,void 0,function(){var a,f;return u(this,function(c){switch(c.label){case 0:return[4,fa(b)];case 1:return a=c.sent(),[4,m.getClassBreaks(ga(a),a.outlineOptimizationEnabled)];case 2:return f=c.sent(),[2,ka(a,f)]}})})};E.createAgeRenderer=function(b){return l(this,void 0,void 0,function(){var a,f,c,d,e,h,k,l,p,n,F,C,z,v,r,t,D,w,B,x,y,E;return u(this,function(g){switch(g.label){case 0:return[4,
ha(b)];case 1:a=g.sent();f=a.defaultSymbolEnabled;c=a.view;d=a.startTime;e=a.endTime;h=a.symbolType;k=a.layer;l={layer:a.layer,view:a.view};z=(C=J).all;if(!a.unit)return[3,2];v={unit:a.unit,statistics:null,valueExpression:null};return[3,4];case 2:return[4,Z({view:c,layer:k,startTime:d,endTime:e})];case 3:v=g.sent(),g.label=4;case 4:return[4,z.apply(C,[[v,a.outlineOptimizationEnabled?O(l):null]])];case 5:return p=g.sent(),n=p[0],F=p[1],r=n.unit,t=n.statistics,D=G.getAgeExpressions({layer:k,startTime:d,
endTime:e,unit:r}).valueExpression,w=Y.substitute(I["ageInfo_"+r],{unit:r,startTime:m.formatDate(d,r,k),endTime:m.formatDate(e,r,k)}),[4,K(R({layer:k,basemap:a.basemap,valueExpression:D,symbolType:h,statistics:t,legendOptions:{title:w},sizeScheme:a.sizeScheme,sizeOptimizationEnabled:a.sizeOptimizationEnabled,view:a.view}))];case 6:return B=g.sent(),x={layer:k,valueExpression:D,defaultSymbolEnabled:f,symbolType:h},y=W(B,F,null,null,x),E=y.renderer.authoringInfo.visualVariables,E.forEach(function(a){return m.updateAgeRendererAuthoringInfoVV(a,
d,e,r)}),[2,A({},y,{unit:r})]}})})}});