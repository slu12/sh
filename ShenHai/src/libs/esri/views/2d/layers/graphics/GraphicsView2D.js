// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/Identifiable ../../../../core/iteratorUtils ../../../../core/MapPool ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/coordsUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../../../symbols/support/cimSymbolUtils ../../../../symbols/support/defaults ../../engine ../../engine/webgl/definitions ../features/support/AttributeStore ../features/support/TileStore ./GraphicContainer ./GraphicProcessingQueue ./GraphicStore ./graphicsUtils ../../../layers/GraphicsView".split(" "),
function(w,C,H,u,Z,x,y,I,J,K,L,D,E,l,M,N,q,O,r,P,p,z,F,Q,A,t,R,S,T,U,V,W,X,Y){function B(l,d,a){if(a.has(l))return a.get(l);d={tile:d,addedOrModified:[],removed:[]};a.set(l,d);return d}Object.defineProperty(C,"__esModule",{value:!0});w=function(w){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=w.apply(this,a)||this;a._tiles=new Map;a._graphicStoreUpdate=!1;a._graphicsSet=new Set;a._matcher=l.resolve(null);a._tileUpdateSet=new Set;a._tilesToUpdate=new Map;a._graphicIdToAbortController=
new Map;a._attached=!1;a._highlightIds=new Map;a._updatingGraphicsTimer=null;a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a.addOrUpdateGraphic=a.addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}H(d,w);d.prototype.initialize=function(){var a=this;this._tileStore=new T.default(this.view.featuresTilingScheme);this.container=new U.default(this.view.featuresTilingScheme,
null);this._attributeStore=new S.default({type:"local",initialize:function(b){return l.resolve(a.container.attributeView.initialize(b))},update:function(b){return a.container.attributeView.requestUpdate(b)},render:function(){return a.container.requestRender()}});this._graphicStore=new W.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,function(b){a._attributeStore.createLocalId(b.uid);a._setFilterState(b.uid,b.visible)},function(b){a._attributeStore.freeLocalId(b.uid)});
this._graphicProcessingQueue=new V.default({process:this.addOrUpdateGraphic});var b=new t.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),!0),c=this._tileStore.tileScheme.tileInfo;this.renderer&&(this._matcher=t.createMatcher(this.renderer,b,null));this._meshFactory=new t.WGLMeshFactory(null,this.uid,null,b,null,c);this.watch("renderer",function(c){c&&(a._matcher=t.createMatcher(a.renderer,b,null))});this._tileStore.on("update",this._onTileUpdate.bind(this));this.container.on("attach",
function(){0<a.graphics.items.length&&a._graphicsChangeHandler({target:a.graphics,added:a.graphics.items,removed:[],moved:[]});a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics");a._attached=!0;a.notifyChange("updating")});this.container.on("detach",function(){a._graphicProcessingQueue&&a._graphicProcessingQueue.clear()})};d.prototype.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating"));
this.container.dispose();this._set("graphics",null);this._graphicProcessingQueue&&(this._graphicProcessingQueue.destroy(),this._graphicProcessingQueue=null);this._graphicStore.clear();this._tileStore.destroy();this._attributeStore=null};Object.defineProperty(d.prototype,"updating",{get:function(){return!this._attached||null!==this._updatingGraphicsTimer||this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size},enumerable:!0,configurable:!0});d.prototype.install=
function(a){a.addChild(this.container)};d.prototype.uninstall=function(a){a.removeChild(this.container)};d.prototype.hitTest=function(a,b){if(!this.view||!this.view.position)return l.resolve();a=this.view.toMap(N.createScreenPoint(a,b));return this.searchFeatures(a).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,b){var c=this;void 0===b&&(b=2);return l.create(function(e){e(c._graphicStore.hitTest(a.x,a.y,b,c.view.state.resolution,c.view.state.rotation))})};
d.prototype.update=function(a){a=a.state;var b=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(b);this._tileStore.setViewState(a);this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate(this))};d.prototype.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};
d.prototype.graphicUpdateHandler=function(a){var b=a.newValue,c=a.graphic;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(c,"update");break;case "visible":this._setFilterState(c.uid,b),this._attributeStore.sendUpdates()}};d.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var e=this._highlightIds.get(c);this._highlightIds.set(c,e+1)}else this._highlightIds.set(c,1)}this._updateHighlight()};d.prototype.removeHighlight=
function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var e=this._highlightIds.get(c)-1;0===e?this._highlightIds.delete(c):this._highlightIds.set(c,e)}}this._updateHighlight()};d.prototype._updateHighlight=function(){this._attributeStore.setHighlight(L.keysOfMap(this._highlightIds))};d.prototype._getIntersectingTiles=function(a){return(a=this._graphicStore.getBounds(a))&&0!==r.width(a)&&0!==r.height(a)?this._tileStore.boundsIntersections(a):[]};d.prototype._updateTile=function(a){var b=
this,c=a.tile,e=this._getGraphicsData(c,a.addedOrModified);return this._processGraphics(c.key,e).then(function(e){b._patchTile(c.key,{addOrUpdate:e,remove:a.removed});return e})};d.prototype._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.onTileData(a,b),this.container.requestRender())};d.prototype._graphicsChangeHandler=function(a){var b=this;if(!this._graphicStoreUpdate){var c=this.view.state,e=this.view.featuresTilingScheme.getClosestInfoForScale(c.scale).level;
this._graphicStore.updateLevel(e);this._tileStore.setViewState(c)}var d=a.added,e=a.removed;a=a.moved;for(var g=this._tilesToUpdate,f,c=[],n=Array(d.length),m=0;m<d.length;m++){var k=d[m];n[m]=k;this._graphicsSet.add(k);c.push(this.addGraphic(k))}for(m=0;m<e.length;m++){k=e[m];this._abortProcessingGraphic(k.uid);for(var d=this._getIntersectingTiles(k),v=0,G=d;v<G.length;v++)d=G[v],f=d.key.id,d=B(f,d,g),d.removed.push(this._attributeStore.getLocalId(k.uid));this._graphicsSet.delete(k);this._graphicStore.remove(k)}for(e=
0;e<a.length;e++)for(m=a[e],d=this._getIntersectingTiles(m),k=0,v=d;k<v.length;k++)d=v[k],f=d.key.id,d=B(f,d,g),d.addedOrModified.push(m);this._flipUpdatingGraphics();l.all(c).then(function(){for(var a,c=0;c<n.length;c++){a=n[c];for(var d=0,e=b._getIntersectingTiles(a);d<e.length;d++){var h=e[d];f=h.key.id;B(f,h,g).addedOrModified.push(a)}}b._graphicStore.updateZ();var k=[];g.forEach(function(a){return k.push(b._updateTile(a))});return l.all(k).then(function(){g.clear();b.notifyChange("updating")})}).catch(function(){g.clear();
b.notifyChange("updating")})};d.prototype._getSymbolResources=function(a,b){return y(this,void 0,void 0,function(){var c,d,h,g,f,n,m,k;return x(this,function(e){switch(e.label){case 0:return this.container.attached?(c=E.isSome(a.symbol)?a.symbol:null)?[3,3]:this.renderer?[4,this.renderer.getSymbolAsync(a,{scale:this.view.scale})]:[3,2]:[2,l.resolve(null)];case 1:return c=e.sent(),[3,3];case 2:c=this._getNullSymbol(a),e.label=3;case 3:return[4,Q.expandSymbol(c,b)];case 4:c=e.sent();d=[];if("text"===
c.type){h=new Set;g=c;f=t.bidiText(g.text)[0];for(n=0;n<f.length;n++)h.add(f.charCodeAt(n));m=[];h.forEach(function(a){return m.push(a)});d.push({symbol:g.toJSON(),id:0,glyphIds:m})}else d.push({symbol:c.toJSON(),id:a.uid,glyphIds:null});return[4,this.container.getMaterialItems(d,b).then(function(a){return a&&0<a.length?a[0].mosaicItem:null})];case 5:return k=e.sent(),[2,{symbol:c,mosaicItem:k}]}})})};d.prototype._projectAndNormalizeGeometry=function(a){return y(this,void 0,void 0,function(){var b,
c,d,h=this;return x(this,function(e){if(E.isNone(a.geometry))return[2,l.resolve(null)];b=a.geometry;p.isPolygon(b)?(c=b.rings,b.rings=c):p.isPolyline(b)?(d=b.paths,b.paths=d):p.isExtent(b)&&(b=O.fromExtent(b));return[2,F.checkProjectionSupport(b.spatialReference,this.view.spatialReference).then(function(){var a=X.normalizeCentralMeridian(b),a=F.project(a,b.spatialReference,h.view.spatialReference);P.closeRingsAndFixWinding(a);return a})]})})};d.prototype._onTileUpdate=function(a){var b=z.getInfo(this.view.spatialReference);
if(a.added&&0<a.added.length)for(var c=0,d=a.added;c<d.length;c++)this._addNewTile(d[c],b);if(a.removed&&0<a.removed.length)for(b=0,a=a.removed;b<a.length;b++)this._removeTile(a[b].key)};d.prototype.addOrUpdateGraphic=function(a,b,c){return this._addOrUpdateGraphic(a,b,c)};d.prototype.addGraphic=function(a){var b=this;this._abortProcessingGraphic(a.uid);var c=M.createAbortController();this._graphicIdToAbortController.set(a.uid,c);return this._addOrUpdateGraphic(a,"add",{signal:c.signal}).then(function(){b._graphicIdToAbortController.delete(a.uid)}).catch(function(c){b._graphicIdToAbortController.delete(a.uid);
if(!l.isAbortError(c))throw c;})};d.prototype._addOrUpdateGraphic=function(a,b,c){var d=this,h=this._projectAndNormalizeGeometry(a),g=this._getSymbolResources(a,c);return l.all([h,g]).then(function(e){var f=e[0];e=e[1];return"add"===b?d._addProjectedGraphic(a,e,f):d._updateGraphic(a,e,f,c)})};d.prototype._addProjectedGraphic=function(a,b,c){this._graphicsSet.has(a)&&this._graphicStore.add(a,b,c)};d.prototype._updateGraphic=function(a,b,c,d){var e=this;if(!this._graphicStore.has(a)||l.isAborted(d))return l.resolve();
c=this._graphicStore.update(a,b,c);b=c.oldBounds;c=c.newBounds;var g=0===r.width(b)&&0===r.height(b),f=0===r.width(c)&&0===r.height(c),g=g?[]:this._tileStore.boundsIntersections(b);b=f?[]:this._tileStore.boundsIntersections(c);c=D.acquire();for(var n=0;n<g.length;n++)f=g[n],c.set(f.key,{addOrUpdate:null,remove:[this._attributeStore.getLocalId(a.uid)]});for(g=0;g<b.length;g++)f=b[g],n=this._getGraphicData(f,a),c.has(f.key)?(f=c.get(f.key),f.remove.length=0,f.addOrUpdate=n):c.set(f.key,{addOrUpdate:n,
remove:null});var m=[];c.forEach(function(a,b){var c=e._processGraphics(b,a.addOrUpdate,d).then(function(c){e._patchTile(b,{addOrUpdate:c,remove:a.remove})});m.push(c)});D.release(c);return l.all(m).then(function(){})};d.prototype._addTile=function(a,b){var c=r.create();this.view.featuresTilingScheme.getTileBounds(c,a);c=new t.WGLTile(a,c,!0);b={clear:!0,addOrUpdate:b,remove:[]};this._tiles.set(a,c);this.container.addChild(c);c.setData(b,!1,!1)};d.prototype._addNewTile=function(a,b){var c=this,d=
this._graphicStore.queryTileData(a);if(b){b=Math.round((b.valid[1]-b.valid[0])/a.resolution);for(var h=0;h<d.length;h++){var g=d[h];g.geometry&&p.isPoint(g.geometry)&&this._wrapPoints(g,b)}}var f=a.key;this._tileUpdateSet.add(a.key);this.notifyChange("updating");this._processGraphics(f,d).then(function(a){c._addTile(f,a);c._tileUpdateSet.delete(f);c.notifyChange("updating")}).catch(function(a){c._tileUpdateSet.delete(f);c.notifyChange("updating");if(!l.isAbortError(a))throw a;})};d.prototype._removeTile=
function(a){if(this._tiles.has(a)){var b=this._tiles.get(a);this.container.removeChild(b);b.destroy();this._tiles.delete(a)}};d.prototype._setFilterState=function(a,b){var c=this._attributeStore.getLocalId(a);a=this._attributeStore.getHighlightFlag(a);this._attributeStore.setData(c,0,0,a|(b?R.FILTER_FLAG_0:0))};d.prototype._getGraphicsData=function(a,b){var c=z.getInfo(this.view.spatialReference);b=this._graphicStore.getGraphicsData(a,b);if(c)for(a=Math.round((c.valid[1]-c.valid[0])/a.resolution),
c=0;c<b.length;c++){var d=b[c];d.geometry&&p.isPoint(d.geometry)&&this._wrapPoints(d,a)}b.sort(function(a,b){return a.insertAfter-b.insertAfter});return b};d.prototype._getGraphicData=function(a,b){b=this._graphicStore.getGraphicData(a,b);var c=[b],d=z.getInfo(this.view.spatialReference);d&&(a=Math.round((d.valid[1]-d.valid[0])/a.resolution),b.geometry&&p.isPoint(b.geometry)&&this._wrapPoints(b,a));return c};d.prototype._wrapPoints=function(a,b){var c=a.geometry;512===b?20>c.x?a.geometry={points:[[c.x,
c.y],[b,0]]}:492<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]}):-20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:532<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};d.prototype._processGraphics=function(a,b,c){return y(this,void 0,void 0,function(){var d,h,g;return x(this,function(e){switch(e.label){case 0:d=b&&b.length;if(!d||!this._meshFactory)return[2,null];h=this._meshFactory;return[4,this._matcher.then(function(a){return h.analyze(b,!0,a,null,null,c)})];case 1:return g=e.sent(),this._attributeStore.sendUpdates(),
[2,this._processAnalyzedGraphics(a,g)]}})})};d.prototype._processAnalyzedGraphics=function(a,b){for(var c=this._meshFactory,d=c.createMeshData(b.length),h=this._attributeStore,g=0;g<b.length;g++){var f=b[g];f.insertAfter=-1===f.insertAfter?-1:h.getLocalId(f.insertAfter);f.localId=h.getLocalId(f.attributes[this.uid]);c.write(d,f,null,null,a.level)}return t.TileData.fromMeshData(d)};d.prototype._abortProcessingGraphic=function(a){this._graphicIdToAbortController.has(a)&&this._graphicIdToAbortController.get(a).abort()};
d.prototype._getNullSymbol=function(a){a=a.geometry;return p.isPolyline(a)?A.errorPolylineSymbol2D:p.isPolygon(a)||p.isExtent(a)?A.errorPolygonSymbol2D:A.errorPointSymbol2D};d.prototype._flipUpdatingGraphics=function(){var a=this;this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer);this._updatingGraphicsTimer=setTimeout(function(){a._updatingGraphicsTimer=null;a.notifyChange("updating")},160);this.notifyChange("updating")};u([q.property()],d.prototype,"_graphicProcessingQueue",void 0);
u([q.property({constructOnly:!0})],d.prototype,"graphics",void 0);u([q.property({dependsOn:["_graphicProcessingQueue.updating"]})],d.prototype,"updating",null);u([q.property()],d.prototype,"view",void 0);u([q.property()],d.prototype,"updateRequested",void 0);return d=u([q.subclass("esri.views.2d.layers.support.GraphicsView2D")],d)}(q.declared(Y.GraphicsView(J.HandleOwnerMixin(K.IdentifiableMixin(I)))));C.default=w});