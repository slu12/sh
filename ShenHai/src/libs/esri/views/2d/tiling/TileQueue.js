// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/Accessor ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../support/QueueProcessor".split(" "),function(B,C,u,e,v,w,x,c,y,z){function A(c,a){c.length=0;a.forEach(function(b){return c.push(b)});return c}var q=new Set,l=[],g=new Map,t=[0,0];return function(r){function a(b){b=
r.call(this,b)||this;b._keyToItem=new Map;b.concurrency=6;b.strategy="scale-first";b.tileInfoView=null;return b}u(a,r);a.prototype.initialize=function(){var b=this,a=this.concurrency,c=this.process,d="scale-first"===this.strategy?this._peekByScaleFirst.bind(this):this._peekByCenterFirst.bind(this);this._queue=new z.QueueProcessor({concurrency:a,process:function(a,d){a=b._keyToItem.get(a);return c(a,{signal:d})},peeker:d})};a.prototype.destroy=function(){this.clear();this._queue.destroy();this._queue=
null};Object.defineProperty(a.prototype,"length",{get:function(){return this._queue?this._queue.length:0},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"onGoingCount",{get:function(){return this._keyToItem.size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return 0<this.length||0<this.onGoingCount},enumerable:!0,configurable:!0});a.prototype.abort=function(b){this._queue.abort("string"===typeof b?b:b.id)};a.prototype.clear=function(){this._queue.clear();
this._keyToItem.clear();this.notifyChange("updating")};a.prototype.get=function(b){return this._queue.get("string"===typeof b?b:b.id)};a.prototype.has=function(b){return"string"===typeof b?this._keyToItem.has(b):this._keyToItem.has(b.id)};a.prototype.isOngoing=function(b){b="string"===typeof b?b:b.id;return this.has(b)&&this._queue.isOngoing(b)};a.prototype.pause=function(){this._queue.pause()};a.prototype.push=function(b){return w(this,void 0,void 0,function(){var a,c,d,k=this;return v(this,function(e){a=
b.key.id;if(this.has(a))return[2,this.get(a)];c=this._queue.push(a);d=function(){k._keyToItem.delete(a);k.notifyChange("updating")};this._keyToItem.set(a,b);c.then(d,d);this.notifyChange("updating");return[2,c]})})};a.prototype.reset=function(){this._queue.reset();this.notifyChange("updating")};a.prototype.resume=function(){this._queue.resume()};a.prototype._peekByScaleFirst=function(b){if(!this.state)return b[0];for(var a=this.tileInfoView,c=Number.NEGATIVE_INFINITY,d=Number.POSITIVE_INFINITY,k=
0;k<b.length;k++){var e=this._keyToItem.get(b[k]),h=this.tileInfoView.getTileScale(e.key);g.has(h)||(g.set(h,[]),c=Math.max(h,c),d=Math.min(h,d));g.get(h).push(e.key);q.add(h)}var f=this.state.scale;g.has(f)||(A(l,q),l.sort(),f=l.reduce(function(b,a){return Math.abs(a-f)<Math.abs(b-f)?a:b},l[0]));f=Math.min(f,c);f=Math.max(f,d);b=g.get(f);var m=a.getClosestInfoForScale(f),n=m.getColumnForX(this.state.center[0]),p=m.getRowForY(this.state.center[1]);b.sort(function(b,a){var c=m.denormalizeCol(b.col,
b.world),d=m.denormalizeCol(a.col,a.world);return Math.sqrt((n-c)*(n-c)+(p-b.row)*(p-b.row))-Math.sqrt((n-d)*(n-d)+(p-a.row)*(p-a.row))});q.clear();g.clear();return b[0].id};a.prototype._peekByCenterFirst=function(b){if(!this.state)return b[0];for(var a=this.tileInfoView,c=this.state.center,d=Number.POSITIVE_INFINITY,e=null,g=0;g<b.length;g++){var h=this._keyToItem.get(b[g]);a.getTileCoords(t,h.key);var f=y.vec2.distance(t,c);f<d&&(d=f,e=h.key)}return e.id};e([c.property({constructOnly:!0})],a.prototype,
"concurrency",void 0);e([c.property({constructOnly:!0})],a.prototype,"process",void 0);e([c.property()],a.prototype,"state",void 0);e([c.property({constructOnly:!0})],a.prototype,"strategy",void 0);e([c.property({constructOnly:!0})],a.prototype,"tileInfoView",void 0);e([c.property({readOnly:!0})],a.prototype,"updating",null);return a=e([c.subclass("esri.views.2d.tiling.TileQueue")],a)}(c.declared(x))});