// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../geometry/support/aaBoundingBox ./PointHighlights ../../support/geometryUtils ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/lib/ComponentUtils ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/lib/ProgramRepository ../../webgl-engine/materials/internal/MaterialUtil ../../webgl-engine/shaders/PointRendererPrograms ../../../webgl/BufferObject ../../../webgl/renderState ../../../webgl/VertexArrayObject".split(" "),
function(v,q,J,C,R,S,r,T,D,U,t,V,W,X,K,A,Y,Z,P,n,Q,h,aa){function E(c,a,b,f,d){if(b.drawScreenSpace)return b.fixedSize*a*f;d=(d?256:64)*a*f;return b.drawFixedSize?Math.min(b.fixedSize/2,d):0<b.screenMinSize?Math.min(Math.max(b.screenMinSize*a*f,c/2),d):Math.min(c/2,d)}Object.defineProperty(q,"__esModule",{value:!0});var ba={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]};v=function(){function c(a){var b=
this;this._params=a;this.type="Point";this._highlights=new V.PointHighlights({forEachNode:function(a){return b.forEachNode(a)},addHighlight:function(a,d,c,g){return b.addHighlight(a,d,c,g)},removeHighlight:function(a,d){return b.removeHighlight(a,d)}});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=t.create(t.POSITIVE_INFINITY);this._programRep=null;
this._recreatePrograms=!0;this._programScreenHighlight=this._programWorldHighlight=this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=null;this.tempMatrix4=R.mat4f32.create();this.tempVec3=T.vec3f32.create();this.nodes=[]}Object.defineProperty(c.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0});c.prototype.initializeRenderContext=function(a){this._initContext=a;this._programRep=new Z(a.rctx);a.requestRender();
this._recreatePrograms=!0};c.prototype.uninitializeRenderContext=function(){this._programRep.dispose();this._programScreenHighlight=this._programWorldHighlight=this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=this._programRep=null};c.prototype.intersect=function(a,b,f,d){var c=this,g=D.vec3f64.create(),m=D.vec3f64.create(),n=D.vec3f64.create(),L=D.vec3f64.create(),u=X.plane.create(),G=a.camera.perScreenPixelRatio/2,p=a.camera.near,w=this._getSizeParams();r.vec3.subtract(m,
d,f);var M=1/r.vec3.length(m);r.vec3.scale(m,m,M);r.vec3.negate(n,m);U.vec4.set(u,m[0],m[1],m[2],-r.vec3.dot(m,f));var q=function(){return function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""}}(),x=new q,y=new q,v=[],N=t.create(),O=t.create(this._clipBox);t.offset(O,-f[0],-f[1],-f[2],O);for(var I=function(k){var F=k.splatSize*C._scaleFactor,e=K.minimumDistancePlane(k.obb,u),l=K.maximumDistancePlane(k.obb,u),e=e-(w.drawScreenSpace?0:E(F,e+p,w,G,k.isLeaf)),l=l-(w.drawScreenSpace?
0:E(F,l+p,w,G,k.isLeaf)),e=null!=x.dist&&null!=y.dist&&x.dist<e*M&&y.dist>l*M;if(0>l||e)return"continue";l=E(F,l+p,w,G,k.isLeaf);if(!K.intersectLine(k.obb,f,m,l))return"continue";var z=l*l;K.toAaBoundingBox(k.obb,N);t.offset(N,-f[0],-f[1],-f[2],N);var A=!t.contains(O,N);r.vec3.subtract(L,k.origin,f);for(var l=k.coordinates.length/3,e=function(e){g[0]=L[0]+k.coordinates[3*e];g[1]=L[1]+k.coordinates[3*e+1];g[2]=L[2]+k.coordinates[3*e+2];if(A&&!t.containsPoint(O,g))return"continue";var l=r.vec3.dot(g,
m),h=r.vec3.squaredLength(g)-l*l;if(h>z)return"continue";var H=l+p,u=w.drawScreenSpace?0:E(F,H,w,G,k.isLeaf);if(0>l-u)return"continue";H=E(F,H-u,w,G,k.isLeaf);if(h>H*H)return"continue";var B=(l-u)*M,l=function(a){var b=a.point;null==b&&(b=D.vec3f64.create());b[0]=k.origin[0]+k.coordinates[3*e];b[1]=k.origin[1]+k.coordinates[3*e+1];b[2]=k.origin[2]+k.coordinates[3*e+2];a.point=b;a.dist=B;a.normal=n;a.node=k;a.pointId=e;a.layerUid=c.layerUid};(null==x.dist||B<x.dist)&&(null==b||b(f,d,B))&&l(x);0!==
a.options.store&&(null==y.dist||B>y.dist)&&(null==b||b(f,d,B))&&l(y);2!==a.options.store||null!=b&&!b(f,d,B)||(h=new q,l(h),v.push(h))},h=0;h<l;h++)e(h)},C=this,e=0,z=this.nodes;e<z.length;e++)I(z[e]);var h=function(a){var b=a.node,d=a.pointId;return{type:"external",point:a.point,metadata:{layerUid:a.layerUid,createGraphic:function(){return c._params.createGraphic(b,d,a.point)}}}},I=function(a,b){var d=h(b);a.set(d,b.layerUid+"/"+b.node.id+"/"+b.pointId,b.dist,b.normal,S.mat4f64.IDENTITY,void 0);
a.intersector="PointRenderer"};null!=x.dist&&(e=a.results.min,(null==e.dist||x.dist<e.dist)&&I(e,x));null!=y.dist&&0!==a.options.store&&(e=a.results.max,(null==e.dist||y.dist>e.dist)&&I(e,y));if(2===a.options.store)for(e=W.ray.fromPoints(f,d),z=0;z<v.length;z++){var J=v[z],A=new Y.IntersectorResult(e);I(A,J);a.results.all.push(A)}};c.prototype.render=function(a){if(0!==a.pass&&1!==a.pass&&4!==a.pass)return!1;for(var b=1===a.pass,f=a.rctx,d=0,c=this.nodes;d<c.length;d++){var g=c[d];null==g.vao&&this._initNode(a,
g)}this._ensurePrograms();d=this._getSizeParams();c=this._selectProgram(a.pass,d);if(null==c||0===this.nodes.length)return!0;var m=this._clipBox,h=!t.equals(m,t.POSITIVE_INFINITY,function(a,b){return a===b});h||(r.vec3.set(this.tempVec3,-Infinity,-Infinity,-Infinity),c.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set(this.tempVec3,Infinity,Infinity,Infinity),c.setUniform3fv("uClipMax",this.tempVec3));f.bindProgram(c);f.setPipelineState(this._pipelineState);c.setUniformMatrix4fv("uProjectionMatrix",
a.camera.projectionMatrix);b&&c.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&P.bindHighlightRendering(f,{viewport:a.camera.fullViewport,highlightDepthTexture:a.highlightDepthTexture},c);b=a.camera.pixelRatio;d.drawFixedSize&&c.setUniform2f("uPointScale",d.fixedSize*b,a.camera.fullHeight);for(var n=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null,u=0,q=this.nodes;u<q.length;u++)if(g=q[u],0!==g.coordinates.length&&(!a.isHighlightPass||g.highlights)){c.setUniform2f("uScreenMinMaxSize",
d.screenMinSize*b,(g.isLeaf?256:64)*b);d.drawFixedSize||c.setUniform2f("uPointScale",g.splatSize*this._scaleFactor*b,a.camera.fullHeight/b);var p=g.origin;h&&(r.vec3.set(this.tempVec3,m[0]-p[0],m[1]-p[1],m[2]-p[2]),c.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set(this.tempVec3,m[3]-p[0],m[4]-p[1],m[5]-p[2]),c.setUniform3fv("uClipMax",this.tempVec3));C.mat4.identity(this.tempMatrix4);C.mat4.translate(this.tempMatrix4,this.tempMatrix4,p);C.mat4.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);
c.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);n&&P.bindSlicePlane(p,n,c);f.bindVAO(g.vao);a.isHighlightPass?this._renderHighlightFragments(f,g):f.drawArrays(0,0,g.coordinates.length/3)}return!0};c.prototype._renderHighlightFragments=function(a,b){var c=b.highlights;if(c){b=J.unwrap(c[0].component);for(var d=b+1,h=1;h<c.length;h++){var g=J.unwrap(c[h].component);g!==d&&(d-=b,0<d&&a.drawArrays(0,b,d),b=g);d=g+1}c=d-b;0<c&&a.drawArrays(0,b,c)}};Object.defineProperty(c.prototype,"useFixedSizes",
{get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=
a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"sizePx",{get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"clippingBox",{set:function(a){t.set(this._clipBox,a||t.POSITIVE_INFINITY)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender(),this._recreatePrograms=
!0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0});c.prototype.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};c.prototype.removeNode=function(a){var b=this,c=null;this.nodes=this.nodes.filter(function(d){return d.id===a?(c=d,d.vao&&(d.vao.dispose(!0),d.vao=null),b._highlights.nodeRemoved(d),!1):!0});this._requestRender();return c};c.prototype.forEachNode=
function(a){this.nodes.forEach(a)};c.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),a.vao=null)});this._highlights.removeAll();this.nodes=[];this._requestRender()};c.prototype.highlight=function(a,b){return this._highlights.add(a,b)};c.prototype.addHighlight=function(a,b,c,d){a.highlights=A.addHighlight(a.highlights,b,c,d);this._requestRender()};c.prototype.removeHighlight=function(a,b){a.highlights=A.removeHighlight(a.highlights,b);this._requestRender()};
c.prototype._initNode=function(a,b){a=a.rctx;b.vao=new aa(a,n.program.attributes,ba,{positions:Q.createVertex(a,35044,b.coordinates),colors:Q.createVertex(a,35044,b.rgb)})};c.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()};c.prototype._getSizeParams=function(){var a=this._useFixedSizes,b=a&&!this._useRealWorldSymbolSizes,c=b?this._sizePx:this._size,d=this._minSizePx;a&&(d=0);return{drawScreenSpace:b,drawFixedSize:a,fixedSize:c,screenMinSize:d}};c.prototype._selectProgram=
function(a,b){b=b.drawScreenSpace;switch(a){case 1:return b?this._programScreenDepth:this._programWorldDepth;case 4:return b?this._programScreenHighlight:this._programWorldHighlight;default:return b?this._programScreen:this._programWorld}};c.prototype._ensurePrograms=function(){this._recreatePrograms&&(this._recreatePrograms=!1,this._programWorld=this._programRep.getProgram(n.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(n.program,{drawScreenSize:!0,
slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(n.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(n.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldHighlight=this._programRep.getProgram(n.program,{highlightPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenHighlight=this._programRep.getProgram(n.program,{drawScreenSize:!0,
highlightPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._pipelineState=h.makePipelineState({depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams}))};return c}();q.PointRenderer=v;(function(c){c.isInstanceOfNode=function(a){return a.hasOwnProperty("splatSize")}})(v=q.PointRenderer||(q.PointRenderer={}));q.PointRenderer=v});