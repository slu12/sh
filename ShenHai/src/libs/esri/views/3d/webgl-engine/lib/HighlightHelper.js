// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f32 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/debugFlags ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ./Util ../shaders/HighlightPrograms ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/renderState ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(D,E,u,t,v,q,w,x,y,z,n,A,r,p,m,B){return function(){function h(b,
f){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};this.blur1Fbo=this.blur0Fbo=this.quadVAO=null;this._rctx=f;this.viewportToRestore=v.vec4f64.create();this.defaultOptions={color:t.vec4f32.fromValues(1,0,1,1),haloColor:t.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};this.blurProgram=b.getProgram(n.blurPass,{gaussianSamples:5});this.blurGridProgram=
b.getProgram(n.blurPass,{gaussianSamples:5,gridOptimization:!0});this.applyProgram=b.getProgram(n.applyPass);this.applyGridProgram=b.getProgram(n.applyPass,{gridOptimization:!0});this.applyGridDebugProgram=b.getProgram(n.applyPass,{gridOptimization:!0,gridDebug:!0});this.downsampleProgram=b.getProgram(n.downsamplePass);this.preprocessPipelineState=p.makePipelineState({colorWrite:p.defaultColorWriteParams});this.applyPipelineState=p.makePipelineState({blending:p.separateBlendingParams(770,1,771,771),
colorWrite:p.defaultColorWriteParams})}Object.defineProperty(h.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(b){b?this.enable():this.disable()},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"profilingCallback",{get:function(){return q.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(b){return console.log(b)}:null},enumerable:!0,configurable:!0});h.prototype.setDefaultOptions=function(b){this.defaultOptions=b};h.prototype.render=function(b,f,C){var c=b.pixelRatio,
e=!q.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,k=q.HIGHLIGHTS_VISUALIZE_BLOCKS,a=this._rctx;z.assert(this.enabled);u.vec4.copy(this.viewportToRestore,b.fullViewport);var g=Math.ceil(b.fullWidth/c);b=Math.ceil(b.fullHeight/c);this.blur0Fbo.resize(g,b);this.blur1Fbo.resize(g,b);a.bindVAO(this.quadVAO);a.setPipelineState(this.preprocessPipelineState);var d=null,l=c=d=null;if(e){var h=this._grid;this._gridUpdateResources(f,32);this._gridComputeMipmap();c=h.vao;l=4;d=this.blurGridProgram;a.bindProgram(d);
a.bindTexture(h.coverageMipmap[h.mipmapLevels].colorTexture,1);d.setUniform1i("coverageTex",1)}else c=this.quadVAO,l=5,d=this.blurProgram,a.bindProgram(d);a.bindVAO(c);a.bindFramebuffer(this.blur0Fbo);a.setViewport(0,0,g,b);a.setClearColor(0,0,0,0);a.clear(16384);d.setUniform1i("tex",0);a.bindTexture(f.colorTexture,0);d.setUniform2f("blurSize",1/g,0);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindFramebuffer(this.blur1Fbo);a.clear(16384);a.bindTexture(this.blur0Fbo.colorTexture,0);d.setUniform2f("blurSize",
0,1/b);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindFramebuffer(C);a.setPipelineState(this.applyPipelineState);a.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);e?(d=k?this.applyGridDebugProgram:this.applyGridProgram,a.bindProgram(d),d.setUniform1i("coverageTex",2),a.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,2)):(d=this.applyProgram,a.bindProgram(d));d.setUniform1i("tex",0);a.bindTexture(this.blur1Fbo.colorTexture,
0);d.setUniform1i("origin",1);a.bindTexture(f.colorTexture,1);d.setUniform4fv("color",this.defaultOptions.color);d.setUniform4fv("haloColor",this.defaultOptions.haloColor);d.setUniform1f("outlineSize",8.6);d.setUniform1f("blurSize",.4);d.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded);a.drawArrays(l,0,m.vertexCount(c,"geometry"));a.bindVAO(null)};h.prototype.enable=function(){if(!this.enabled){this.quadVAO=
y.createQuadVAO(this._rctx);var b={colorTarget:0,depthStencilTarget:0,width:0,height:0},f={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new r(this._rctx,b,f);this.blur1Fbo=new r(this._rctx,b,f)}};h.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.blur1Fbo=this.blur0Fbo=this.quadVAO=null)};h.prototype._gridUpdateResources=function(b,f){var h=this._rctx,c=this._grid,
e=!1;null===c.coverageMipmap&&(c.coverageMipmap=[b],e=!0);if(c.viewportWidth!==b.width||c.viewportHeight!==b.height)e=!0,c.viewportWidth=b.width,c.viewportHeight=b.height;c.coverageMipmap[0]=b;c.cellPixelSize!==f&&(c.cellPixelSize=f,e=!0);if(e){for(f=1;f<c.coverageMipmap.length;f++)c.coverageMipmap[f].dispose();c.mipmapLevels=Math.ceil(Math.log(c.cellPixelSize)*Math.LOG2E);c.coverageMipmap.length=c.mipmapLevels+1;for(f=0;f<c.mipmapLevels;f++)e=c.coverageMipmap[f],e=new r(h,{colorTarget:0,depthStencilTarget:0,
width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)},{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)}),c.coverageMipmap[f+1]=e}var e=Math.ceil(b.height/c.cellPixelSize),k=Math.ceil(b.width/c.cellPixelSize);if(!c.vao||c.verticalCellCount!==e||c.horizontalCellCount!==k){c.verticalCellCount=e;c.horizontalCellCount=k;b=e+1;f=k+1;for(var e=1/e,k=1/k,a=new Float32Array(24*b*f),g=0,d=0;d<b;d++)for(var l=0;l<f;l++)a[g+
0]=(l-.5)*k*2-1,a[g+1]=(d-.5)*e*2-1,a[g+2]=l*k,a[g+3]=d*e,a[g+4]=(l+.5)*k*2-1,a[g+5]=(d-.5)*e*2-1,a[g+6]=l*k,a[g+7]=d*e,a[g+8]=(l-.5)*k*2-1,a[g+9]=(d+.5)*e*2-1,a[g+10]=l*k,a[g+11]=d*e,a[g+12]=(l-.5)*k*2-1,a[g+13]=(d+.5)*e*2-1,a[g+14]=l*k,a[g+15]=d*e,a[g+16]=(l+.5)*k*2-1,a[g+17]=(d-.5)*e*2-1,a[g+18]=l*k,a[g+19]=d*e,a[g+20]=(l+.5)*k*2-1,a[g+21]=(d+.5)*e*2-1,a[g+22]=l*k,a[g+23]=d*e,g+=24;c.vao&&c.vao.dispose(!0);c.vao=new B(h,w.Default3D,{geometry:x.Pos2Tex},{geometry:A.createVertex(h,35044,a)})}};h.prototype._gridComputeMipmap=
function(){var b=this._rctx,f=this._grid,h=this.downsampleProgram;b.bindVAO(this.quadVAO);for(var c=0;c<f.mipmapLevels;c++){b.bindFramebuffer(f.coverageMipmap[c+1]);b.bindTexture(f.coverageMipmap[c].colorTexture,0);var e=f.coverageMipmap[c+1].width,k=f.coverageMipmap[c+1].height;b.bindProgram(h);h.setUniform1i("tex",0);h.setUniform2f("invFramebufferDim",1/e,1/k);b.setViewport(0,0,e,k);b.drawArrays(5,0,m.vertexCount(this.quadVAO,"geometry"))}};h.prototype.getGpuMemoryUsage=function(){var b=m.getGpuMemoryUsage(this.blur0Fbo)+
m.getGpuMemoryUsage(this.blur1Fbo);if(this._grid&&this._grid.coverageMipmap)for(var f=0,h=this._grid.coverageMipmap;f<h.length;f++)b+=m.getGpuMemoryUsage(h[f]);return b};return h}()});