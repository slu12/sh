// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.14/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/number ../../core/maybe ../../core/now ../../core/PooledArray ../../core/watchUtils ./debugFlags".split(" "),function(e,f,q,r,t,m,u,v){function n(b){return b in f.taskPriorities?f.taskPriorities[b]:"number"===typeof b?b:1}Object.defineProperty(f,"__esModule",{value:!0});var d;f.newScheduler=function(b){return new k.Scheduler(b)};(function(b){b.REMOTE_CLIENT="remote client";b.STREAM_DATA_LOADER="stream data loader";b.TERRAIN_SURFACE="terrain surface";b.SURFACE_GEOMETRY_UPDATES=
"surface geometry updates";b.I3S_CONTROLLER="I3s controller";b.POINT_CLOUD_LAYER="point cloud";b.FEATURE_TILE_FETCHER="feature fetcher";b.DECONFLICTOR_IMMEDIATE="fast deconflictor";b.DECONFLICTOR_DELAYED="delayed deconflictor";b.GRAPHICS_CORE="Graphics3D";b.FILTER_VISIBILITY="Graphics3D filter visibility";b.FEATURE_QUERY_ENGINE="feature query";b.SCALE_VISIBILITY="Graphics3D scale visibility";b.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";b.POINT_OF_INTEREST_FREQUENT="POI frequent";b.POINT_OF_INTEREST_INFREQUENT=
"POI infrequent";b.LABELER="labeler";b.FEATURE_TILE_TREE="feature tile tree";b.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";b.ELEVATION_ALIGNMENT="elevation alignment";b.TEXT_TEXTURE_ATLAS="text texture atlas";b.OVERLAY_MANAGER="overlay manager";b.INTERACTIVE_TOOL="interactive tool";b[b.TEST_PRIO=1]="TEST_PRIO"})(e=f.Task||(f.Task={}));f.taskPriorities=(d={},d[e.REMOTE_CLIENT]=1,d[e.STREAM_DATA_LOADER]=1,d[e.TERRAIN_SURFACE]=1,d[e.SURFACE_GEOMETRY_UPDATES]=1,d[e.I3S_CONTROLLER]=2,d[e.POINT_CLOUD_LAYER]=
2,d[e.FEATURE_TILE_FETCHER]=2,d[e.DECONFLICTOR_IMMEDIATE]=2,d[e.DECONFLICTOR_DELAYED]=12,d[e.GRAPHICS_CORE]=3,d[e.FILTER_VISIBILITY]=4,d[e.FEATURE_QUERY_ENGINE]=4,d[e.SCALE_VISIBILITY]=6,d[e.FRUSTUM_VISIBILITY]=6,d[e.POINT_OF_INTEREST_FREQUENT]=6,d[e.POINT_OF_INTEREST_INFREQUENT]=30,d[e.LABELER]=8,d[e.FEATURE_TILE_TREE]=12,d[e.FEATURE_TILE_TREE_ACTIVE]=1,d[e.ELEVATION_ALIGNMENT]=12,d[e.TEXT_TEXTURE_ATLAS]=12,d[e.OVERLAY_MANAGER]=12,d[e.INTERACTIVE_TOOL]=16,d);f.getTaskPriority=n;var k;(function(b){var d=
function(){function a(c){var a=this;this._now=c;this._budget=null;this._state=1;this._tasks=new m;this._runQueue=new m;this._load=0;this._idleStateCallbacks=new m;this._idleUpdatesStartFired=!1;this._maxReschedule=p;this._forceTask=!1;this._safetyBudget=0;this._debug=!1;this._debugHandle=u.init(v,"SCHEDULER_LOG_SLOW_TASKS",function(c){return a._debug=c});this._budget=new b.Budget(c);var h=this;this._test={state:void 0,FRAME_SAFETY_BUDGET:1,idleBudget:100,get budget(){return h._budget.budget},usedBudget:0,
startTime:0,updateTask:function(c){return a._updateTask(c)},getState:function(c){return a._getState(c)},getRuntime:function(c){return a._getRuntime(c)}}}a.prototype.destroy=function(){this._debugHandle&&this._debugHandle.remove()};a.prototype.registerTask=function(c,b,a){var l=this,d=n(c),h=new e(c,b,a,d);this._tasks.push(h);return{remove:function(){return l._removeTask(h)},set task(c){h.setPriority(c)}}};a.prototype.registerIdleStateCallbacks=function(c,b){var a=this,d={idleBegin:c,idleEnd:b};this._idleStateCallbacks.push(d);
2===this.state&&this._idleUpdatesStartFired&&d.idleBegin();var l=this;return{remove:function(){return a._removeIdleStateCallbacks(d)},set idleBegin(c){l._idleUpdatesStartFired&&(d.idleEnd(),2===l._state&&c());d.idleBegin=c},set idleEnd(c){d.idleEnd=c}}};Object.defineProperty(a.prototype,"now",{get:function(){return this._now()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"load",{get:function(){return this._load},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"state",{get:function(){return r.isNone(this._test.state)?this._state:this._test.state},set:function(c){this._state!==c&&(this._state=c,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEach(function(c){return c.idleEnd()})))},enumerable:!0,configurable:!0});a.prototype.updateBudget=function(c){var b=2===this.state,a=c.frameDuration;switch(this.state){case 2:a=100;break;case 1:a=Math.max(33,c.frameDuration);break;case 0:a=c.frameDuration}this._safetyBudget=
b?0:1;a-=c.elapsedFrameTime+this._safetyBudget;this._test.usedBudget=0;this._test.startTime=c.elapsedFrameTime;if(!b&&0>a&&!this._forceTask)return this._forceTask=!0,!1;a=Math.max(a,5);this._budget.reset(a,b);this._maxReschedule=p;this._updateLoad();return this._schedule()};a.prototype.frame=function(){this._forceTask=!1;switch(this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forEach(function(c){return c.idleBegin()}));this._runIdle();break;
case 1:this._runMoving();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed};a.prototype._removeIdleStateCallbacks=function(c){this._idleUpdatesStartFired&&c.idleEnd();this._idleStateCallbacks.removeUnordered(c)};a.prototype._removeTask=function(c){this._tasks.removeUnordered(c);this._runQueue.removeUnordered(c)};a.prototype._updateTask=function(c){this._tasks.forEach(function(a){a.name===c&&a.setPriority(c)})};a.prototype._getState=function(c){if(this._runQueue.some(function(a){return a.name===
c}))return g.SCHEDULED;var a=g.IDLE;this._tasks.forEach(function(b){b.name===c&&b.needsUpdate()&&(1>=b.schedule?a=g.READY:a!==g.READY&&(a=g.WAITING))});return a};a.prototype._getRuntime=function(c){var a=0;this._tasks.forEach(function(b){b.name===c&&(a+=b.runtime)});return a};a.prototype._runIdle=function(){this._run()};a.prototype._runMoving=function(){this._run()};a.prototype._runAnimating=function(){this._run()};a.prototype._updateLoad=function(){var c=0;this._tasks.forEach(function(a){return a.needsUpdate()?
++c:c});this._load=.9*this._load+c*(1-.9)};a.prototype._schedule=function(){var c=this;if(0>=this._maxReschedule)return!1;this._runQueue.filterInPlace(function(c){if(c.needsUpdate())return!0;c.schedule=c.priority;return!1});for(var a=function(){var a=!1,d=0;b._tasks.forEach(function(b){if(b.needsUpdate())switch(a=!0,d=Math.max(d,b.priority),b.schedule){case 0:break;case 1:b.schedule=0;c._runQueue.push(b);break;default:--b.schedule}});if(!a)return{value:!1};b._maxReschedule===p&&(b._maxReschedule=
d);--b._maxReschedule},b=this;0===this._runQueue.length;){var d=a();if("object"===typeof d)return d.value}return!0};a.prototype._run=function(){do for(;0<this._runQueue.length;){var c=this._runQueue.pop();this._budget.resetProgress();var a=this._budget.now();c.update(this._budget);c.schedule=c.priority;c.runtime+=this._budget.now()-a;this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",c.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms");if(0>=this._budget.remaining)return}while(this._schedule())};
Object.defineProperty(a.prototype,"test",{get:function(){return this._test},enumerable:!0,configurable:!0});return a}();b.Scheduler=d;var e=function(){function a(c,a,b,d){this.name=c;this.update=a;this.needsUpdate=b;this._priority=d;this.runtime=0;this.schedule=this._priority}Object.defineProperty(a.prototype,"priority",{get:function(){return this._priority},enumerable:!0,configurable:!0});a.prototype.setPriority=function(a){var c=n(a);this.name=a;this._priority=c;0!==this.schedule&&(this.schedule=
c)};return a}(),d=function(){function a(a){this.now=a;this._budget=this._begin=0;this._didWork=this._idle=!1;this._enabled=!0}a.prototype.run=function(a){if(this.done)return!1;!0===a()&&(this._didWork=!0);return!0};Object.defineProperty(a.prototype,"done",{get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"budget",{get:function(){return this._budget},enumerable:!0,configurable:!0});a.prototype.madeProgress=
function(){this._didWork=!0};Object.defineProperty(a.prototype,"idleFrame",{get:function(){return this._idle},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a},enumerable:!0,configurable:!0});a.prototype.reset=function(a,b){this._begin=this.now();this._budget=a;this._idle=b;this._didWork=!1};Object.defineProperty(a.prototype,"remaining",{get:function(){return Math.max(this._budget-this.elapsed,0)},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"elapsed",{get:function(){return this.now()-this._begin},enumerable:!0,configurable:!0});a.prototype.resetProgress=function(){this._didWork=!1};Object.defineProperty(a.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0});return a}();b.Budget=d})(k||(k={}));var g;(function(b){b.SCHEDULED="s";b.READY="r";b.WAITING="w";b.IDLE="i"})(g=f.TaskState||(f.TaskState={}));f.noBudget=function(){var b=new k.Budget(t);
b.enabled=!1;return b}();var p=q.MAX_SAFE_INTEGER});